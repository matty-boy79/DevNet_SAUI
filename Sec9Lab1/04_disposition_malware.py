import sys
import json
import requests

CLIENT_ID = 'client-c18b32c9-b4d1-4739-9ab4-621c80a897d5'
CLIENT_PASSWORD = 'tqBYLI5oiPZ6UKNHdl_T6OQijpJjcik4kWkJiytMZ-nHx-bWOGZRng'

SESSION = requests.session()

def generate_token():
    ''' Generate a new access token and write it to disk
    '''
    url = 'https://visibility.amp.cisco.com/iroh/oauth2/token'

    headers = {'Content-Type':'application/x-www-form-urlencoded',
               'Accept':'application/json'}

    payload = {'grant_type':'client_credentials'}

    response = requests.post(url, headers=headers, auth=(CLIENT_ID, CLIENT_PASSWORD), data=payload)

    if unauthorized(response):
        sys.exit('Unable to generate new token!\nCheck your CLIENT_ID and CLIENT_PASSWORD')

    response_json = response.json()
    access_token = response_json['access_token']

    with open('threat_response_token', 'w') as token_file:
        token_file.write(access_token)

def get_token():
    ''' Get the access token from disk if it's not there generate a new one
    '''
    for i in range(2):
        while True:
            try:
                with open('threat_response_token', 'r') as token_file:
                    access_token = token_file.read()
                    return access_token
            except FileNotFoundError:
                generate_token()
            break

def inspect(observable):
    '''Inspect the provided obsrevable and determine it's type
    '''
    inspect_url = 'https://visibility.amp.cisco.com/iroh/iroh-inspect/inspect'

    access_token = get_token()

    headers = {'Authorization':'Bearer {}'.format(access_token),
               'Content-Type':'application/json',
               'Accept':'application/json'}

    inspect_payload = {'content':observable}
    inspect_payload = json.dumps(inspect_payload)

    response = SESSION.post(inspect_url, headers=headers, data=inspect_payload)
    return response

def enrich(observable):
    ''' Query the API for a observable
    '''
    enrich_url = 'https://visibility.amp.cisco.com/iroh/iroh-enrich/deliberate/observables'

    access_token = get_token()

    headers = {'Authorization':'Bearer {}'.format(access_token),
               'Content-Type':'application/json',
               'Accept':'application/json'}

    response = SESSION.post(enrich_url, headers=headers, data=observable)

    return response

def unauthorized(response):
    ''' Check the status code of the response
    '''
    if response.status_code == 401 or response.status_code == 400:
        return True
    return False

def check_auth(function, param):
    ''' Query the API and validate authentication was successful
        If authentication fails, generate a new token and try again
    '''
    response = function(param)
    if unauthorized(response):
        generate_token()
        return function(param)
    return response

def query(observable):
    print("Calling API with SHA256 = " + observable)

    response = check_auth(inspect, observable)
    inspect_output = response.text
    response = check_auth(enrich, inspect_output)

    response_json = response.json()

    print("-----------------------------------------------------------------------------")
    print('{:^25}{:^25}{:25}'.format("Module Name",
                                      "Disposition Name",
                                      "Observable value"))
    for module in response_json['data']:
        module_name = module['module']
        if 'verdicts' in module['data'] and module['data']['verdicts']['count'] > 0:
            docs = module['data']['verdicts']['docs']
            for doc in docs:
                observable_value = doc['observable']['value']
                disposition_name = doc.get('disposition_name', 'None')
                print('{:^25}{:^25}{}'.format(module_name, disposition_name, observable_value))
    print("-----------------------------------------------------------------------------")

def main():
    # Loop forever
    while True:
        ex_sha256_value1 = '3b0c62cb455a2f925b1cf3f6561c51d4deb91b79256e6f8a4ab8fb32e45d73c9'
        ex_sha256_value2 = '063f7d2a0c20ac05560c877b87d7f20f6490b444e5857560b87daea4c2b62f1c'
        ex_sha256_value3 = 'd8620959d996715e269dfdde8ce679ebbc799d5c9a809b1c7c6a6ef91af96387'

        # Print the menu
        print("""
                                Disposition of a Malware Threat
                                 ACME Inc, IT Security Department
                       """)
        print("[1] Example Malware1: " + ex_sha256_value1)
        print("[2] Example Malware2: " + ex_sha256_value2)
        print("[3] Non Malware     : " + ex_sha256_value3)
        print("")

        sha256 = input("  Enter SHA256 value/Example Number(Leave blank to end): ")
        sha256 = sha256.strip()
        if not sha256:
            sys.exit()

        if sha256 == '1':
            sha256 = ex_sha256_value1
        elif sha256 == '2':
            sha256 = ex_sha256_value2
        elif sha256 == '3':
            sha256 = ex_sha256_value3

        query(sha256)


if __name__ == '__main__':
    main()